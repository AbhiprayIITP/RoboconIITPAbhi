/* *** *** ***
Mega -  ok       18.758/253.952 - 2.090/8.192
Leonardo - ok    21.498/28.672 - 2.059/2.560
UNO - no ok      18.800/32.256 - 2.090/2.048
*** *** *** */

#include <Wire.h>
#include <math.h>
int TempSensor = A0;

#include "IRremote.h"


/*
controllare un condizionatore via web
con sensori di temperatura e umidit√†
ARDUINO UNO - limitato
Mega o Leonardo
ETHERNET SHIELD
DHT22, IR led
*/

IRsend irsend;
int khz = 38; //NB Change this default value as neccessary to the correct modulation frequency
int temp_critical = 30;
//int temp_normal = temp_critical-;


// ON Deumidificatore

// OFF - AC
unsigned OFF_FINAL[] = {5112, 2084, 488, 1668, 468, 612, 468, 612, 468, 612, 468, 1688, 468, 616, 464, 612, 468, 612, 468, 612, 468, 1688, 468, 612, 468, 1692, 464, 1696, 464, 616, 468, 1688, 464, 1696, 464, 1692, 464, 1696, 464, 1696, 464, 616, 464, 1692, 464, 616, 468, 612, 468, 612, 468, 612, 464, 612, 468, 612, 468, 1692, 464, 1692, 464, 616, 468, 612, 468, 612, 468, 612, 464, 616, 464, 1692, 464, 616, 468, 612, 464, 616, 464, 616, 464, 612, 468, 612, 468, 612, 468, 612, 464, 616, 464, 612, 468, 612, 468, 612, 468, 612, 464, 616, 464, 1692, 464, 1696, 464, 1696, 464, 1692, 464, 616, 468, 612, 464, 616, 464, 29304, 5112, 2084, 464, 1696, 464, 616, 468, 612, 464, 612, 468, 1692, 464, 616, 468, 612, 464, 616, 464, 612, 468, 1692, 464, 616, 468, 1688, 464, 1696, 464, 616, 468, 1688, 464, 1696, 464, 1696, 464, 1692, 468, 1692, 464, 616, 468, 1692, 484, 596, 464, 612, 468, 612, 468, 612, 468, 612, 464, 616, 464, 1692, 492, 1668, 464, 616, 468, 612, 464, 612, 468, 612, 468, 612, 468, 612, 464, 616, 472, 608, 464, 612, 468, 612, 468, 612, 468, 1692, 464, 1692, 464, 616, 468, 612, 464, 1696, 464, 1692, 464, 1696, 464, 616, 464, 616, 464, 616, 464, 612, 468, 612, 468, 612, 464, 616, 464, 616, 464, 612, 468, 612, 468, 612, 464, 616, 464, 616, 464, 612, 468, 1692, 464, 616, 464, 616, 464, 616, 464, 612, 468, 612, 468, 612, 464, 616, 464, 616, 464, 616, 464, 612, 468, 612, 468, 612, 464, 616, 464, 616, 464, 616, 464, 612, 468, 612, 464, 616, 464, 616, 464, 1692, 464, 1696, 464, 1696, 464, 616, 464, 612, 468, 612, 468, 612, 464, 1696, 464, 616, 464, 1692, 464, 616, 464, 1696, 464, 616, 464, 612, 468, 612, 464, 616, 464, 616, 464, 616, 464, 616, 464, 612, 468, 612, 464, 616, 464, 616, 464, 616, 464, 612, 468, 612, 468, 612, 464, 616, 464, 1696, 460, 616, 468, 612, 464, 616, 464, 616, 464, 616, 464, 616, 464, 1692, 464, 1696, 464, 1692, 464, 1700, 460};
unsigned ON_FINAL[] = {5116, 2080, 464, 1696, 464, 616, 468, 612, 468, 612, 468, 1688, 464, 616, 468, 612, 472, 608, 468, 612, 464, 1692, 464, 616, 468, 1692, 464, 1692, 464, 616, 468, 1692, 464, 1692, 464, 1696, 464, 1696, 464, 1692, 464, 616, 468, 1692, 464, 616, 468, 612, 464, 616, 464, 620, 460, 612, 468, 612, 468, 1688, 464, 1696, 464, 616, 468, 612, 464, 616, 464, 616, 464, 612, 468, 1692, 464, 616, 464, 616, 464, 616, 464, 612, 468, 612, 468, 612, 468, 612, 464, 616, 464, 612, 468, 612, 468, 612, 468, 612, 464, 616, 464, 616, 464, 1692, 464, 1696, 464, 1692, 468, 1692, 464, 616, 468, 616, 460, 616, 464, 29304, 5112, 2084, 464, 1696, 464, 612, 468, 612, 468, 612, 468, 1692, 464, 616, 464, 616, 464, 612, 468, 612, 468, 1692, 464, 616, 464, 1692, 464, 1696, 464, 616, 464, 1692, 464, 1696, 464, 1696, 464, 1692, 464, 1696, 464, 616, 464, 1692, 468, 612, 468, 612, 468, 612, 468, 612, 464, 616, 464, 612, 468, 1692, 464, 1696, 464, 612, 468, 612, 468, 612, 468, 612, 468, 612, 464, 616, 464, 616, 464, 612, 468, 612, 468, 612, 468, 612, 464, 1692, 464, 1696, 464, 616, 468, 612, 464, 1692, 464, 1696, 464, 1692, 468, 612, 468, 612, 468, 612, 468, 612, 464, 616, 464, 616, 464, 616, 464, 612, 468, 612, 468, 1692, 464, 616, 464, 612, 468, 612, 468, 612, 468, 1692, 464, 612, 468, 612, 468, 612, 468, 612, 464, 616, 464, 616, 464, 612, 468, 612, 468, 612, 468, 612, 464, 616, 464, 616, 464, 612, 468, 612, 468, 612, 464, 616, 464, 616, 464, 616, 464, 612, 468, 1692, 464, 1696, 464, 1692, 464, 616, 468, 612, 464, 616, 464, 616, 464, 1692, 464, 616, 464, 1696, 464, 616, 464, 1692, 464, 616, 464, 616, 464, 616, 464, 616, 464, 612, 468, 612, 464, 616, 464, 616, 464, 616, 464, 616, 464, 612, 468, 612, 464, 616, 464, 616, 464, 616, 464, 612, 468, 1692, 464, 616, 464, 616, 464, 1692, 464, 616, 464, 616, 464, 616, 464, 1692, 468, 1692, 464, 1696, 464, 1692, 464};
//unsigned Fan[] = { 5120, 2076, 412, 1744, 416, 664, 416, 664, 440, 640, 440, 1716, 416, 664, 440, 640, 440, 640, 440, 640, 440, 1716, 416, 664, 440, 1720, 416, 1740, 416, 668, 440, 1716, 440, 1720, 440, 1716, 440, 1720, 440, 1720, 440, 640, 440, 1716, 440, 640, 440, 640, 440, 640, 440, 640, 440, 636, 444, 636, 440, 1720, 440, 1716, 440, 640, 440, 640, 440, 640, 440, 640, 440, 640, 440, 1716, 440, 640, 440, 640, 440, 640, 440, 640, 440, 636, 444, 636, 440, 640, 440, 640, 440, 640, 440, 636, 444, 636, 440, 640, 440, 640, 440, 640, 440, 1716, 440, 1720, 440, 1720, 440, 1716, 440, 640, 440, 640, 440, 640, 440, 29328, 5144, 2052, 440, 1720, 440, 640, 440, 640, 440, 636, 444, 1716, 440, 640, 440, 640, 440, 640, 440, 636, 440, 1720, 440, 640, 440, 1716, 440, 1720, 440, 640, 440, 1716, 440, 1720, 440, 1720, 440, 1716, 440, 1720, 416, 664, 440, 1720, 412, 668, 436, 640, 440, 640, 440, 640, 440, 640, 440, 640, 440, 1716, 416, 1744, 412, 668, 440, 640, 436, 644, 436, 640, 440, 640, 416, 664, 440, 640, 440, 640, 436, 640, 440, 640, 432, 648, 412, 1748, 412, 1744, 416, 664, 416, 664, 412, 1744, 416, 1744, 416, 1744, 412, 668, 412, 668, 412, 664, 416, 664, 416, 664, 412, 668, 412, 668, 412, 668, 412, 664, 416, 664, 416, 664, 412, 668, 412, 668, 412, 1744, 412, 668, 412, 668, 412, 668, 412, 668, 412, 668, 412, 664, 416, 664, 412, 668, 412, 668, 412, 668, 412, 664, 416, 664, 412, 668, 412, 668, 412, 668, 412, 668, 412, 664, 416, 664, 416, 664, 412, 668, 412, 668, 412, 664, 416, 664, 412, 668, 412, 1748, 412, 668, 412, 664, 416, 664, 412, 1748, 412, 1744, 412, 668, 416, 1744, 412, 1748, 412, 668, 412, 664, 416, 664, 412, 668, 412, 668, 412, 668, 412, 664, 416, 664, 412, 668, 412, 668, 412, 668, 412, 668, 412, 668, 412, 664, 412, 668, 412, 1748, 404, 676, 412, 668, 408, 1748, 384, 1772, 384, 696, 412, 668, 412, 1748, 384, 696, 408, 672, 408, 668, 412};
//unsigned OFF3[]  =  {5064, 2132, 468, 1692, 468, 612, 468, 612, 468, 612, 468, 1688, 468, 612, 468, 612, 468, 612, 468, 612, 468, 1688, 464, 616, 468, 1688, 468, 1692, 468, 612, 468, 1688, 468, 1692, 468, 1692, 464, 1692, 468, 1692, 468, 612, 468, 1688, 468, 612, 472, 612, 464, 612, 468, 612, 468, 612, 468, 612, 468, 1688, 464, 1696, 464, 616, 468, 612, 468, 608, 468, 612, 468, 612, 468, 1692, 464, 612, 472, 608, 468, 612, 468, 612, 468, 612, 468, 612, 468, 608, 468, 612, 468, 612, 468, 612, 468, 612, 468, 612, 468, 608, 468, 612, 468, 1692, 464, 1692, 468, 1692, 464, 1696, 464, 616, 468, 608, 468, 612, 468, 29300, 5112, 2084, 468, 1692, 468, 612, 468, 612, 468, 612, 468, 1688, 468, 612, 468, 612, 468, 612, 468, 612, 468, 1688, 464, 616, 468, 1692, 464, 1692, 468, 612, 468, 1692, 464, 1692, 468, 1692, 464, 1696, 464, 1692, 468, 612, 468, 1692, 464, 616, 468, 612, 468, 608, 468, 612, 468, 612, 468, 612, 468, 1688, 468, 1692, 464, 616, 468, 612, 468, 612, 468, 608, 468, 612, 468, 612, 468, 612, 468, 612, 468, 612, 464, 620, 460, 612, 468, 1692, 464, 1692, 468, 612, 468, 612, 468, 1692, 464, 1692, 468, 1692, 464, 616, 468, 612, 468, 612, 464, 612, 468, 612, 468, 612, 468, 612, 468, 612, 468, 612, 468, 608, 468, 612, 468, 612, 468, 612, 468, 612, 464, 1692, 464, 616, 468, 612, 468, 612, 468, 612, 464, 616, 464, 612, 468, 612, 468, 616, 464, 612, 464, 616, 464, 616, 464, 612, 468, 612, 468, 612, 468, 612, 464, 616, 464, 612, 468, 612, 468, 612, 468, 1688, 468, 1692, 464, 1696, 464, 616, 464, 616, 464, 612, 468, 612, 468, 1692, 488, 592, 464, 1692, 464, 616, 468, 1692, 488, 592, 464, 612, 468, 612, 468, 612, 468, 612, 464, 616, 464, 616, 464, 612, 468, 612, 468, 612, 464, 616, 464, 616, 464, 616, 464, 612, 468, 612, 468, 612, 464, 1692, 464, 616, 468, 612, 468, 612, 468, 612, 464, 616, 464, 616, 464, 1692, 464, 1696, 464, 1692, 464, 1696, 464};
//unsigned ON[] = {5064, 2132, 468, 1692, 468, 612, 468, 612, 468, 612, 468, 1688, 468, 612, 468, 612, 468, 612, 468, 612, 468, 1688, 468, 612, 468, 1692, 464, 1692, 468, 616, 468, 1688, 468, 1692, 468, 1688, 468, 1692, 468, 1692, 464, 616, 468, 1688, 468, 612, 472, 608, 468, 612, 468, 612, 468, 612, 468, 612, 464, 1692, 468, 1692, 464, 616, 468, 612, 468, 612, 464, 612, 468, 612, 468, 1692, 464, 616, 468, 612, 464, 616, 464, 612, 468, 612, 468, 612, 468, 612, 468, 612, 464, 616, 464, 612, 468, 612, 468, 612, 468, 612, 468, 612, 464, 1692, 464, 1696, 464, 1696, 464, 1696, 464, 612, 468, 612, 468, 612, 468, 29304, 5064, 2132, 468, 1692, 464, 616, 468, 612, 468, 612, 464, 1692, 464, 616, 468, 612, 468, 612, 468, 612, 464, 1692, 464, 620, 464, 1692, 464, 1696, 464, 616, 464, 1692, 464, 1696, 464, 1692, 468, 1692, 464, 1696, 464, 616, 468, 1692, 460, 620, 464, 612, 468, 612, 468, 612, 468, 612, 464, 616, 464, 1692, 464, 1696, 464, 616, 468, 612, 464, 616, 464, 616, 464, 612, 468, 612, 468, 612, 464, 616, 464, 616, 464, 616, 464, 612, 468, 1692, 436, 1724, 456, 624, 464, 616, 464, 1692, 436, 1724, 436, 1720, 440, 644, 464, 612, 464, 616, 464, 616, 464, 616, 464, 616, 464, 616, 464, 616, 460, 616, 464, 616, 464, 616, 464, 616, 464, 616, 464, 616, 460, 1696, 436, 644, 464, 616, 464, 616, 464, 616, 464, 616, 460, 616, 464, 616, 464, 616, 464, 616, 464, 616, 460, 620, 460, 616, 464, 616, 464, 616, 464, 616, 464, 616, 464, 616, 460, 620, 460, 616, 464, 1696, 436, 1724, 436, 644, 460, 1696, 436, 644, 464, 616, 464, 616, 464, 1692, 440, 644, 460, 1696, 436, 644, 464, 1692, 440, 644, 460, 616, 464, 616, 464, 616, 464, 616, 464, 616, 460, 620, 460, 620, 460, 616, 464, 616, 464, 616, 464, 616, 460, 620, 460, 620, 460, 616, 464, 616, 464, 1696, 436, 644, 464, 616, 460, 620, 460, 620, 460, 616, 464, 1696, 436, 1720, 440, 1720, 436, 1724, 436, 1724, 436};


int irPin = 3; // pin IR led
int count = 0;
int x = 0;            //On_check 1=ON 0=OFF
int temp;
int receivedValue;
float resistance = 0;
int a = 0;
//int b = 3985;








void setup() {
  
 Wire.begin(8);                /* join i2c bus with address 8 */
Wire.onReceive(receiveEvent); /* register receive event */
 Wire.onRequest(requestEvent); /* register request event */
 Serial.begin(9600); 
  pinMode(TempSensor , INPUT);                              /* start serial for debug */

  pinMode(irPin, OUTPUT);
  
  //Serial.begin(115200);
  pinMode(LED_BUILTIN,OUTPUT);
  digitalWrite(LED_BUILTIN , LOW);
}

void loop() {


    a = analogRead(TempSensor);
    resistance = (float)(1023-a)*10000/a;
    temp = 1/(log(resistance/10000) / 3985 + 1/298.15) - 273.15;
    delay(1000);
    //Serial.println(temp);
    
   if(temp>temp_critical && x == 0){
    ON();
    }
    else if(temp<(temp_critical-4) && x == 1){
      OFF();
      }
    
      
      }


   
    





void ON(){
   irsend.sendRaw(ON_FINAL, sizeof(ON_FINAL) / sizeof(int), khz);
   digitalWrite(LED_BUILTIN , LOW);
   x = 1;
  }

void OFF(){
  digitalWrite(LED_BUILTIN,HIGH);
  irsend.sendRaw(OFF_FINAL, sizeof(OFF_FINAL) / sizeof(int), khz);
 x = 0;
   
  }

void receiveEvent(int howMany) {
while(0<Wire.available()){
    
    receivedValue = Wire.read() << 8;
    receivedValue |= Wire.read();
    temp_critical = receivedValue; 
    //Serial.println(receivedValue);
    //Serial.println("InsideWhile");
}

}

void requestEvent() {

int Send = temp*10 + x;




// Send two bytes to slave.
//Wire.beginTransmission(1);
Wire.write(Send >> 8);
Wire.write(Send & 255);

}  


  
